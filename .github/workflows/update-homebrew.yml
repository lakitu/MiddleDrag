# .github/workflows/update-homebrew.yml
name: Update Homebrew Tap
permissions:
  contents: read

on:
  repository_dispatch:
    types: [homebrew_release]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update (e.g., 2.0.1) - leave empty to use latest release"
        required: false
        type: string

jobs:
  update-tap:
    runs-on: macos-latest
    steps:
      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            # Repository dispatch event
            VERSION="${{ github.event.client_payload.version }}"
            VERSION="${VERSION#v}"
          elif [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with specified version
            VERSION="${{ inputs.version }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            # Release event
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            # Manual trigger without version - get latest release
            VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Update Homebrew Cask
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download and get SHA
          curl -L -o MiddleDrag.pkg "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag-${VERSION}.pkg"
          SHA=$(shasum -a 256 MiddleDrag.pkg | awk '{print $1}')

          # Clone tap repo and update
          git clone --depth 1 --filter=blob:none --sparse \
            https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/nullpointerdepressivedisorder/homebrew-tap.git
          cd homebrew-tap
          git sparse-checkout set Casks

          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/middledrag.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA}\"/" Casks/middledrag.rb

          # Update the rest using awk for safety
          awk -v ver="$VERSION" '{
            # Replace .zip with .pkg in URL
            gsub(/\.zip/, ".pkg")
            gsub(/MiddleDrag-.*\.pkg/, "MiddleDrag-" ver ".pkg")
            gsub(/MiddleDrag-.*\.zip/, "MiddleDrag-" ver ".pkg")

            # Replace app stanza with pkg stanza (if converting from zip)
            if ($0 ~ /app "MiddleDrag.app"/) {
              print "  pkg \"MiddleDrag-" ver ".pkg\""
              print "  uninstall pkgutil: \"app.middledrag.MiddleDrag\""
            } 
            # Update existing pkg stanza (if already pkg)
            else if ($0 ~ /pkg "MiddleDrag.*.pkg"/) {
              print "  pkg \"MiddleDrag-" ver ".pkg\""
            }
            else {
              print
            }
          }' Casks/middledrag.rb > Casks/middledrag.rb.tmp
          mv Casks/middledrag.rb.tmp Casks/middledrag.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/middledrag.rb
          git commit -m "Update MiddleDrag to ${VERSION}"
          git push
