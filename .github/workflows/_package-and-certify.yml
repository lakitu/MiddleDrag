name: Package and Certify

on:
  workflow_call:
    inputs:
      version:
        description: Version of the .app to package and certify
        required: true
        type: string
    outputs:
      package-name:
        description: Name of the uploaded artifact
        value: ${{ jobs.package-and-certify.outputs.package-name }}

permissions:
  contents: write

jobs:
  package-and-certify:
    runs-on: macos-latest
    outputs:
      package-name: ${{ steps.package.outputs.pkg-name }}

    steps:
      - name: download-app
        uses: actions/download-artifact@v4
        with:
          name: MiddleDrag-App-${{ inputs.version }}
          path: .

      - name: Unzip app
        run: unzip -q MiddleDrag-App-${{ inputs.version }}.zip

      - name: Install certificates
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
          INSTALLER_CERTIFICATE_BASE64: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12_BASE64 }}
          INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          echo "$INSTALLER_CERTIFICATE_BASE64" | base64 --decode > installer.p12

          PROVISIONING_PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROVISIONING_PROFILE_DIR"
          if [ -n "$PROVISIONING_PROFILE_BASE64" ]; then
            echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROVISIONING_PROFILE_DIR/provisioning_profile.mobileprovision"
            echo "Provisioning profile installed at: $PROVISIONING_PROFILE_DIR/provisioning_profile.mobileprovision"
          else
            echo "Warning: PROVISIONING_PROFILE_BASE64 is not set, skipping provisioning profile installation"
          fi

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security import installer.p12 -k build.keychain -P "$INSTALLER_CERTIFICATE_PASSWORD" -T /usr/bin/pkgbuild -T /usr/bin/productbuild -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Sign app
        run: |
          PROVISIONING_PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/provisioning_profile.mobileprovision"
          if [ -f "$PROVISIONING_PROFILE_PATH" ]; then
            cp "$PROVISIONING_PROFILE_PATH" MiddleDrag.app/Contents/embedded.provisionprofile
            echo "Provisioning profile copied to app bundle"
          else
            echo "Warning: Provisioning profile not found at $PROVISIONING_PROFILE_PATH, skipping copy"
          fi

          codesign --deep --force --options runtime \
          --sign "Developer ID Application: Karan Mohindroo (${{ vars.TEAM_ID }})" \
          MiddleDrag.app

      - name: Package app
        id: package
        run: |
          mkdir -p payload/Applications
          mkdir -p scripts
          
          # Create preinstall script to ensure clean installation
          cat > scripts/preinstall << 'EOF'
#!/bin/bash
# Quit the app if running (pkill is more reliable for menu bar apps)
pkill -x MiddleDrag 2>/dev/null || true
sleep 1

# Remove existing app (handles both manual and Homebrew installs)
rm -rf "/Applications/MiddleDrag.app"

# Forget any existing package receipts
pkgutil --forget app.middledrag.MiddleDrag 2>/dev/null || true

exit 0
EOF
          chmod +x scripts/preinstall
          
          mv MiddleDrag.app payload/Applications/
          pkgbuild --root payload \
            --scripts scripts \
            --identifier app.middledrag.MiddleDrag \
            --version ${{ inputs.version }} \
            --install-location / \
            --sign "Developer ID Installer: Karan Mohindroo (${{ vars.TEAM_ID }})" \
            MiddleDrag-${{ inputs.version }}.pkg

          echo "pkg-name=MiddleDrag-${{ inputs.version }}" >> $GITHUB_OUTPUT

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          NOTARY_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool submit MiddleDrag-${{ inputs.version }}.pkg \
          --apple-id "$APPLE_ID" \
          --team-id ${{ vars.TEAM_ID }} \
          --password "$NOTARY_PASSWORD" \
          --wait

          xcrun stapler staple MiddleDrag-${{ inputs.version }}.pkg

      - name: Upload Notarized app
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.pkg-name }}
          path: ${{ steps.package.outputs.pkg-name }}.pkg
          retention-days: 1
