# Reusable workflow for Sentry uploads
name: Sentry Upload

on:
    workflow_call:
        inputs:
            version:
                description: Version number for Sentry release
                required: true
                type: string
            artifact-name:
                description: Name of the build artifact containing dSYMs
                required: true
                type: string
        secrets:
            SENTRY_AUTH_TOKEN:
                required: true
            SENTRY_ORG:
                required: true
            SENTRY_PROJECT:
                required: true

permissions:
    contents: read

jobs:
    upload:
        name: Upload to Sentry
        runs-on: macos-latest

        steps:
            - name: Download dSYM Artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ inputs.artifact-name }}-dSYM
                  path: dSYM

            - name: Setup Sentry CLI
              uses: mathieu-bour/setup-sentry-cli@v2
              with:
                  version: latest

            - name: Upload dSYM to Sentry
              env:
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
              run: |
                  sentry-cli debug-files upload --include-sources dSYM/

            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create Sentry Release
              env:
                  SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
                  SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
                  SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
              run: |
                  VERSION="v${{ inputs.version }}"
                  sentry-cli releases new "$VERSION"
                  sentry-cli releases set-commits "$VERSION" --auto
                  sentry-cli releases finalize "$VERSION"
                  sentry-cli releases deploys "$VERSION" new -e production
