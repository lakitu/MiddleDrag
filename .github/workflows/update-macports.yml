name: Update MacPorts Portfile
permissions:
  contents: read

on:
  repository_dispatch:
    types: [macports_release]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update (e.g., 2.0.1) - leave empty to use latest release"
        required: false
        type: string

jobs:
  update-portfile:
    runs-on: macos-latest
    steps:
      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            # Repository dispatch event
            VERSION="${{ github.event.client_payload.version }}"
            VERSION="${VERSION#v}"
          elif [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with specified version
            VERSION="${{ inputs.version }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            # Release event
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            # Manual trigger without version - get latest release
            VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Update Portfile and create PR
        env:
          GH_TOKEN: ${{ secrets.MACPORTS_PORTS_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH_NAME="middledrag-${VERSION}"

          # Download source tarball
          curl -L -o source.tar.gz "https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"

          # Calculate checksums
          RMD160=$(openssl dgst -rmd160 source.tar.gz | awk -F'= ' '{print $2}')
          SHA256=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          SIZE=$(wc -c < source.tar.gz | tr -d ' ')

          echo "RMD160: $RMD160"
          echo "SHA256: $SHA256"
          echo "SIZE: $SIZE"

          git clone --depth 1 --filter=blob:none --sparse \
            https://x-access-token:${GH_TOKEN}@github.com/NullPointerDepressiveDisorder/macports-ports.git
          cd macports-ports
          git sparse-checkout set sysutils/MiddleDrag

          # Add upstream and fetch latest
          git remote add upstream https://github.com/macports/macports-ports.git
          git fetch upstream master --depth 1

          # Create branch from upstream/master
          git checkout -b "${BRANCH_NAME}" upstream/master

          # Re-apply sparse checkout after branch switch
          git sparse-checkout set sysutils/MiddleDrag

          PORTFILE="sysutils/MiddleDrag/Portfile"

          if [ ! -f "$PORTFILE" ]; then
            echo "Error: Portfile not found at $PORTFILE"
            exit 1
          fi

          # Update version (Handles github.setup line)
          sed -i '' -E "s/^(github.setup[[:space:]]+[^[:space:]]+[[:space:]]+[^[:space:]]+[[:space:]]+)[^[:space:]]+/\1${VERSION}/" "$PORTFILE"

          # Update checksums (Handles variable whitespace)
          sed -i '' -E "s/(rmd160[[:space:]]+)[0-9a-f]+/\1${RMD160}/" "$PORTFILE"
          sed -i '' -E "s/(sha256[[:space:]]+)[0-9a-f]+/\1${SHA256}/" "$PORTFILE"
          sed -i '' -E "s/(size[[:space:]]+)[0-9]+/\1${SIZE}/" "$PORTFILE"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$PORTFILE"

          # Check if there are changes before committing
          if git diff --staged --quiet; then
            echo "No changes to commit - Portfile already up to date"
            exit 0
          fi

          # Commit with MacPorts convention: <portname>: <description>
          git commit -m "MiddleDrag: update to ${VERSION}"

          # Push to fork
          git push -u origin "${BRANCH_NAME}" --force

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --repo macports/macports-ports --head "NullPointerDepressiveDisorder:${BRANCH_NAME}" --json number --jq 'if length > 0 then .[0].number else empty end' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #${EXISTING_PR} already exists, updated with latest changes"
          else
            # Create PR against upstream
            gh pr create \
              --repo macports/macports-ports \
              --base master \
              --head "NullPointerDepressiveDisorder:${BRANCH_NAME}" \
              --title "MiddleDrag: update to ${VERSION}" \
              --body "Routine version update for MiddleDrag to ${VERSION}.

            Release notes: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          fi
