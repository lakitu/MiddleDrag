name: Update MacPorts Portfile
permissions:
  contents: read

on:
  repository_dispatch:
    types: [macports_release]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update (e.g., 2.0.1) - leave empty to use latest release"
        required: false
        type: string

jobs:
  update-portfile:
    runs-on: macos-latest
    steps:
      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with specified version
            VERSION="${{ inputs.version }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            # Release event
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            # Manual trigger without version - get latest release
            VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Update Portfile
        env:
          MACPORTS_PORTS_TOKEN: ${{ secrets.MACPORTS_PORTS_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download source tarball
          curl -L -o source.tar.gz "https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"

          # Calculate checksums
          RMD160=$(openssl dgst -rmd160 source.tar.gz | awk -F'= ' '{print $2}')
          SHA256=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          SIZE=$(wc -c < source.tar.gz | tr -d ' ')

          echo "RMD160: $RMD160"
          echo "SHA256: $SHA256"
          echo "SIZE: $SIZE"

          # Clone ports repo
          git clone --depth 1 --filter=blob:none --sparse \
            https://x-access-token:${MACPORTS_PORTS_TOKEN}@github.com/nullpointerdepressivedisorder/macports-ports.git
          cd macports-ports
          git sparse-checkout set sysutils/MiddleDrag

          PORTFILE="sysutils/MiddleDrag/Portfile"

          if [ ! -f "$PORTFILE" ]; then
            echo "Error: Portfile not found at $PORTFILE"
            exit 1
          fi

          # Update version (Handles github.setup line)
          sed -i '' -E "s/^(github.setup[[:space:]]+[^[:space:]]+[[:space:]]+[^[:space:]]+[[:space:]]+)[^[:space:]]+/\1${VERSION}/" "$PORTFILE"

          # Update checksums (Handles variable whitespace)
          sed -i '' -E "s/(rmd160[[:space:]]+)[0-9a-f]+/\1${RMD160}/" "$PORTFILE"
          sed -i '' -E "s/(sha256[[:space:]]+)[0-9a-f]+/\1${SHA256}/" "$PORTFILE"
          sed -i '' -E "s/(size[[:space:]]+)[0-9]+/\1${SIZE}/" "$PORTFILE"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$PORTFILE"

          # Check if there are changes before committing
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update MiddleDrag to ${VERSION}"
            git push
          fi
