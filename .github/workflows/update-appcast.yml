# .github/workflows/update-appcast.yml
name: Update Appcast

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to add (e.g., 2.0.1) - leave empty to use latest release"
        required: false
        type: string
  repository_dispatch:
    types: [appcast_release]

permissions:
  contents: write

jobs:
  update-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          elif [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(gh release view --repo ${{ github.repository }} --json tagName -q '.tagName')
          fi
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

      - name: Download release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          curl -L -o "MiddleDrag-${VERSION}.pkg" \
            "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag-${VERSION}.pkg"

      - name: Install Sparkle
        run: |
          # Download Sparkle 2.6.4 for sign_update tool
          curl -L -o Sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz"
          mkdir -p Sparkle
          tar -xf Sparkle.tar.xz -C Sparkle

      - name: Generate appcast entry
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_EDDSA_PRIVATE_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_FILE="MiddleDrag-${VERSION}.pkg"
          
          # Get file size
          FILE_SIZE=$(stat -f%z "$PKG_FILE")
          
          # Generate EdDSA signature
          SIGNATURE=$(echo -n "$SPARKLE_PRIVATE_KEY" | ./Sparkle/bin/sign_update "$PKG_FILE" 2>&1)
          SIGN_EXIT_CODE=$?
          
          if [ $SIGN_EXIT_CODE -ne 0 ] || [ -z "$SIGNATURE" ]; then
            echo "::error::Failed to generate EdDSA signature"
            echo "sign_update output: $SIGNATURE"
            exit 1
          fi
          
          # Validate signature looks like base64 (basic sanity check)
          if ! echo "$SIGNATURE" | grep -qE '^[A-Za-z0-9+/=]+$'; then
            echo "::error::Generated signature doesn't look valid: $SIGNATURE"
            exit 1
          fi
          
          echo "Generated signature: ${SIGNATURE:0:20}... (truncated)"
          
          # Get release notes from GitHub and escape for XML
          RELEASE_NOTES=$(gh release view "v${VERSION}" --repo ${{ github.repository }} --json body -q '.body' | \
            sed "s/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g; s/'/\&apos;/g")
          
          # Get current date in RFC 2822 format
          PUB_DATE=$(date -R)
          
          # Download URL
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/MiddleDrag-${VERSION}.pkg"
          
          # Create new item entry
          cat > new_item.xml << EOF
          <item>
            <title>Version ${VERSION}</title>
            <pubDate>${PUB_DATE}</pubDate>
            <sparkle:version>${VERSION}</sparkle:version>
            <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
            <description><![CDATA[
          ${RELEASE_NOTES}
                ]]></description>
                <enclosure 
                  url="${DOWNLOAD_URL}"
                  sparkle:edSignature="${SIGNATURE}"
                  length="${FILE_SIZE}"
                  type="application/octet-stream" />
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
              </item>
          EOF
                    
                    echo "Generated appcast entry for version ${VERSION}"
                    cat new_item.xml

                - name: Update appcast.xml
                  run: |
                    VERSION="${{ steps.version.outputs.version }}"
                    
                    if [ ! -f appcast.xml ]; then
                      # Create initial appcast.xml if it doesn't exist
                      cat > appcast.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
            <channel>
              <title>MiddleDrag Updates</title>
              <link>https://middledrag.app</link>
              <description>Most recent updates to MiddleDrag</description>
              <language>en</language>
            </channel>
          </rss>
          EOF
          fi
          
          # Remove existing entry for this version if present (handles re-runs)
          # Using Python for reliable multi-line XML manipulation
          if grep -q "sparkle:version>${VERSION}<" appcast.xml; then
            echo "Version ${VERSION} already exists in appcast, removing old entry..."
            python3 - "$VERSION" << 'PY'
          import sys
          version = sys.argv[1]
          needle = f"sparkle:version>{version}<"

          with open("appcast.xml", "r", encoding="utf-8") as f:
              lines = f.readlines()

          out_lines = []
          in_item = False
          buffer = []
          skip_item = False

          for line in lines:
              if "<item>" in line and not in_item:
                  in_item = True
                  buffer = [line]
                  skip_item = False
              elif in_item:
                  buffer.append(line)
                  if needle in line:
                      skip_item = True
                  if "</item>" in line:
                      if not skip_item:
                          out_lines.extend(buffer)
                      in_item = False
                      buffer = []
              else:
                  out_lines.append(line)

          with open("appcast.xml", "w", encoding="utf-8") as f:
              f.writelines(out_lines)
          PY
          fi
          
          # Insert new item after </language> tag
          sed -i '' "/<\/language>/r new_item.xml" appcast.xml
          
          # Clean up
          rm -f new_item.xml
          
          echo "Updated appcast.xml:"
          cat appcast.xml

      - name: Commit and push
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add appcast.xml
          git commit -m "Update appcast for version ${VERSION}" || echo "No changes to commit"
          git push
